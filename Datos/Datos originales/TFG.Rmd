---
title: "TFG"
output: html_document
date: "2023-09-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(tidyr)
library(dplyr)
library(xlsx)
library(openxlsx)
library(zoo)
```

# Datasets de la Poblacion Española:

```{r}
Poblacion <- read_excel("Poblacion_España.xls")

Migraciones_internas <- read_excel("Migracion_interna.xls")

Migracion_externa_entrada <- read_excel("Migracion_externa_entrada.xls")

Migracion_externa_salida <- read_excel("Migracion_externa_salida.xls")

Natalidad <- read_excel("Natalidad.xls")

Mortalidad <- read_excel("Mortalidad.xls")

Extension_territorial_Provincias <- read_excel("Extension territorial Provincias.xlsx", 
    sheet = "Provincias")

Provincias_Comunidad <- read_excel("Provincias_Comunidad.xlsx")

Poblacion_Edad <- read_excel("Poblacion_Edad.xls")
```

## Organizacion de los datos de la Poblacion:

```{r}
Poblacion<- Poblacion %>% gather(key="Año",value="Poblacion", -Provincia)

filas_separar = Poblacion$Provincia %in% c("Total", "Hombres", "Mujeres")

valores = Poblacion$Provincia[!filas_separar]

# Crear un nuevo vector para almacenar los valores repetidos
valores_repetidos <- c()

# Iterar a través de los valores originales y repetir cada uno tres veces
for (valor in valores) {
  valores_repetidos <- c(valores_repetidos, rep(valor, times = 3))
}


Poblacion <- Poblacion[complete.cases(Poblacion), ]

Poblacion$Genero = Poblacion$Provincia

Poblacion$Provincia = valores_repetidos

Poblacion = Poblacion %>% select(1,2,4,3) %>% filter(Año > 1974)

Poblacion = Poblacion %>% pivot_wider(names_from = Genero, values_from = Poblacion)
```

## Dataset Migraciones Internas:

```{r}
provincias_origen = unique(Migraciones_internas$Provincia_destino)

x = c(1)

for ( i in 1:52) {
  x = c(x,1+(i*54))
}

Migraciones_internas <- Migraciones_internas[-x, ]

valores_repetidos_2 <- c()

# Iterar a través de los valores originales y repetir cada uno tres veces
for (valor in provincias_origen) {
  valores_repetidos_2 <- c(valores_repetidos_2, rep(valor, times = 53))
}

Migraciones_internas$Provincia_origen = valores_repetidos_2

Migraciones_internas = Migraciones_internas %>%  select(16,1:15)

Migracion_interna_salida = Migraciones_internas %>% 
                          filter(Provincia_origen == "Total Nacional") %>%
                          gather(key="Año",value="Migracion_interna_salida", c(-Provincia_origen,-Provincia_destino)) %>% 
                          select(2,3,4)

names(Migracion_interna_salida) = c("Provincia","Año","Migracion_interna_salida")
```

```{r}
Migracion_interna_entrada = Migraciones_internas %>% 
                          filter(Provincia_destino == "Total Nacional") %>%
                          gather(key="Año",value="Migracion_interna_entrada", c(-Provincia_origen,-Provincia_destino)) %>% 
                          select(1,3,4)

names(Migracion_interna_entrada) = c("Provincia","Año","Migracion_interna_entrada")

Migracion_interna_entrada$Migracion_interna_entrada[Migracion_interna_entrada$Provincia == "Total Nacional"] = NA
```


## Dataset Migraciones Externas Entrada y Salida:

```{r}
Migracion_externa_entrada<- Migracion_externa_entrada  %>%
  gather(key="Año",value="Migracion_externa_entrada", -Provincia)

Migracion_externa_salida<- Migracion_externa_salida  %>%
  gather(key="Año",value="Migracion_externa_salida", -Provincia)
```

## Dataset Natalildad:
```{r}
Natalidad$Provincia[Natalidad$Provincia == "Total"] = "Total Nacional"

Natalidad<- Natalidad  %>%
  gather(key="Año",value="Natalidad", -Provincia)
```

## Dataset Mortalidad:

```{r}
Mortalidad$Provincia[Mortalidad$Provincia == "Total"] = "Total Nacional"

Mortalidad<- Mortalidad %>%
  gather(key="Año",value="Mortalidad", -Provincia)
```

## Provinvias y Comunidades Autonomas

```{r}
Provincias_Comunidad = Provincias_Comunidad %>% select(2,4)

Provincias_Comunidad = Provincias_Comunidad[complete.cases(Provincias_Comunidad), ]

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Ceuta"] = "Ceuta y Melilla"

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Melilla"] = "Ceuta y Melilla"

# Dividir los valores en dos partes y quedarse con la primera parte
Provincias_Comunidad$Provincia <- sapply(strsplit(Provincias_Comunidad$Provincia, "/"), `[`, 1)

# Quedarse solo con el  nombre
Provincias_Comunidad$Provincia <- sub("^\\d{2} ", "", Provincias_Comunidad$Provincia)

# Corregir los nombres de algunas Provincias
Provincias_Comunidad$Provincia[Provincias_Comunidad$Provincia == "Balears, Illes"] = "Baleares"

Provincias_Comunidad$Provincia[Provincias_Comunidad$Provincia == "Coruña, A"] = "A Coruña"

Provincias_Comunidad$Provincia[Provincias_Comunidad$Provincia == "Palmas, Las"] = "Las Palmas"

Provincias_Comunidad$Provincia[Provincias_Comunidad$Provincia == "Rioja, La"] = "La Rioja"

Provincias_Comunidad$Provincia[Provincias_Comunidad$Provincia == "Gipuzkoa"] = "Guipúzcoa"

Provincias_Comunidad$Provincia[Provincias_Comunidad$Provincia == "Araba"] = "Álava"

Provincias_Comunidad$Provincia[Provincias_Comunidad$Provincia == "Bizkaia"] = "Vizcaya"

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Balears, Illes"] = "Islas Baleares"

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Asturias, Principado de"] = "Principado de Asturias"

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Comunitat Valenciana"] = "Comunidad Valenciana"	

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Madrid, Comunidad de"] = "Comunidad de Madrid"

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Murcia, Región de"] = "Región de Murcia"	

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Navarra, Comunidad Foral de"] = "Comunidad Foral de Navarra"

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Rioja, La"] = "La Rioja"

Provincias_Comunidad$`Comunidad Autónoma`[Provincias_Comunidad$`Comunidad Autónoma` == "Castilla - La Mancha"] = "Castilla-La Mancha"

names(Provincias_Comunidad) = c("Comunidad","Provincia")
```


## Extension de las Provincias:

```{r}
names(Extension_territorial_Provincias) = c("Provincia","Superficie")
# Calcular la suma de todas las provincias
total_superficie <- sum(Extension_territorial_Provincias$Superficie)

# Crear una nueva fila para la provincia "Total"
fila_total <- data.frame(
  Provincia = "Total Nacional",
  Superficie= total_superficie
)

# Unir la nueva fila al dataframe original
Extension_territorial_Provincias <- rbind(Extension_territorial_Provincias, fila_total)
```

## Unbion de todos los datasets:

```{r}

#Juntamos la columna de Natalidad
Poblacion = merge(Poblacion,Natalidad,all = TRUE)

#Juntamos la columna de Mortalidad
Poblacion = merge(Poblacion,Mortalidad,all = TRUE)

#Juntamos la columna de Migracion interna entrada
Poblacion = merge(Poblacion,Migracion_interna_entrada,all = TRUE) 

#Juntamos la columna de Migracion interna Saldia
Poblacion = merge(Poblacion,Migracion_interna_salida,all = TRUE)

#Juntamos la columna de Migracion externa entrada
Poblacion = merge(Poblacion,Migracion_externa_entrada,all = TRUE)

#Juntamos la columna de Migracion externa Saldia
Poblacion = merge(Poblacion,Migracion_externa_salida,all = TRUE) 
```


## Limpiamos la columna de Provincia:

```{r}
# Dividir los valores en dos partes y quedarse con la primera parte
Poblacion$Provincia <- sapply(strsplit(Poblacion$Provincia, "/"), `[`, 1)

# Quedarse solo con el  nombre
Poblacion$Provincia <- sub("^\\d{2} ", "", Poblacion$Provincia)

# Corregir los nombres de algunas Provincias
Poblacion$Provincia[Poblacion$Provincia == "Balears, Illes"] = "Baleares"

Poblacion$Provincia[Poblacion$Provincia == "Coruña, A"] = "A Coruña"

Poblacion$Provincia[Poblacion$Provincia == "Palmas, Las"] = "Las Palmas"

Poblacion$Provincia[Poblacion$Provincia == "Rioja, La"] = "La Rioja"

Poblacion$Provincia[Poblacion$Provincia == "Gipuzkoa"] = "Guipúzcoa"

Poblacion$Provincia[Poblacion$Provincia == "Araba"] = "Álava"

Poblacion$Provincia[Poblacion$Provincia == "Bizkaia"] = "Vizcaya"

Poblacion = Poblacion %>%
  inner_join(Extension_territorial_Provincias, by = "Provincia")
```

```{r}
#Juntamos la columna de Migracion externa Saldia
Poblacion = merge(Poblacion,Provincias_Comunidad,all = TRUE)

Poblacion = Poblacion %>% select(13,c(1:12))

Poblacion$Comunidad[is.na(Poblacion$Comunidad)] = "Total Nacional"
```


## Nuevo indicador de la variacion de la poblacion:

```{r}
Poblacion[is.na(Poblacion)] <- 0

Poblacion = Poblacion %>%
  arrange(Provincia, Año) %>%
  group_by(Provincia) %>%
  mutate(
    Variacion = lag((Natalidad + Migracion_interna_entrada + Migracion_externa_entrada) -
                (Migracion_interna_salida + Mortalidad + Migracion_externa_salida)),
    
    Poblacion_Km2 = round(`Total` / Superficie,2),
    
    Tasa_natalidad = round(Natalidad / Total * 1000),
    
    Tasa_mortalidad = round(Mortalidad / Total * 1000),
    
    Tasa_Migracion = ifelse(Provincia == "Total Nacional", 
                            round((Migracion_externa_entrada - Migracion_externa_salida) / Total * 1000), 
                            round((( Migracion_interna_entrada + Migracion_externa_entrada) - 
                            (Migracion_interna_salida + Migracion_externa_salida)) / Total * 1000))
)

```

## Posibles Tablas para el TFG

```{r}
Tabla_Comunidad_Poblacion = Poblacion  %>% 
  arrange(Comunidad, Año) %>%
  group_by(Comunidad, Año) %>%
  summarise(Poblacion_Comunidad = sum(Total),
            Densidad_Poblacion = sum(Poblacion_Km2))

Tabla_Comunidad_Poblacion <- Tabla_Comunidad_Poblacion %>%
  group_by(Comunidad) %>%
  mutate(Variacion_Poblacion_5 = round((Poblacion_Comunidad - lag(Poblacion_Comunidad, 5)) / lag(Poblacion_Comunidad, 5) * 100,2),
         Variacion_Poblacion_10 = round((Poblacion_Comunidad - lag(Poblacion_Comunidad, 10)) / lag(Poblacion_Comunidad, 10) * 100,2)
         ) %>% 
  filter(Año > 1999 & Año < 2021) %>% 
  select(1,2,4,3,5,6)

```



## Niveles para una variable:

```{r}
# # Especificar los límites de los intervalos
# min_poblacion <- 53647
# max_poblacion <- 6726640
# niveles <- 90
# 
# # Calcular el ancho de cada intervalo
# ancho_intervalo <- (max_poblacion - min_poblacion) / niveles
# 
# # Crear los intervalos y asignar niveles
# Poblacion$Nivel_Total <- cut(
#   Poblacion$Total,
#   breaks = seq(min_poblacion, max_poblacion, by = ancho_intervalo),
#   labels = FALSE
# )
```

```{r}
write.xlsx(Poblacion,"../Poblacion_Provincias.xlsx",sheetName = "Poblacion_Provincias")
#write.xlsx(Poblacion,"Poblacion_Provincias.xlsx",sheetName = "Poblacion_Provincias")
```

## Poblacion Con Grupos de Edad

```{r}
filas = seq(1,21301,213)

edad = Poblacion_Edad$Provincias[filas]

valores_edad <- c()

for (valor in edad) {
  valores_edad <- c(valores_edad, rep(valor, times = 213))
}
Poblacion_Edad$Edad = valores_edad

Poblacion_Edad = Poblacion_Edad[-filas,]
```

```{r}
filas_2 = seq(1,21412,4)

prov = Poblacion_Edad$Provincias[filas_2]

valores_prov <- c()

for (valor in prov) {
  valores_prov <- c(valores_prov, rep(valor, times = 4))
}

Poblacion_Edad$Provincias_2 = valores_prov

Poblacion_Edad = Poblacion_Edad[-filas_2,] %>% select(50,49,1:48)

```

```{r}
Poblacion_Edad<- Poblacion_Edad %>% gather(key="Año",value="Poblacion", c(-Provincias,-Edad,-Provincias_2)) %>%
  pivot_wider(names_from = Provincias, values_from = Poblacion) %>% 
  select(1,3,2,4,5,6)

names(Poblacion_Edad) = c("Provincia","Año","Edad","Total","Hombres","Mujeres")
```

```{r}
Poblacion_Edad$Edad <- as.numeric(gsub("[^0-9]", "", Poblacion_Edad$Edad))

etiquetas_edades <- c("0 a 9", "10 a 19", "20 a 29", "30 a 39", "40 a 49", "50 a 59", "60 a 69", "70 a 79", "80 a 89", "90 a 99")


# Asigna etiquetas de grupo de edades basadas en valores de Edad
Poblacion_Edad <- Poblacion_Edad %>%
  mutate(Grupo_Edad = cut(Edad, breaks = seq(0, 100, by = 10), right = FALSE, labels = etiquetas_edades))

# Agrupa por Provincia, Año y Grupo_Edad y suma la población
Poblacion_Edad <- Poblacion_Edad %>%
  group_by(Provincia, Año, Grupo_Edad) %>%
  mutate(
    Poblacion_Total = sum(Total),
    Poblacion_Hombres = sum(Hombres),
    Poblacion_Mujeres = sum(Mujeres)
  ) %>% 
  select(Provincia,Año,Grupo_Edad,Poblacion_Total,Poblacion_Hombres,Poblacion_Mujeres)

names(Poblacion_Edad) = c("Provincia","Año","Grupo_Edad","Total","Hombres","Mujeres")
```


```{r}
# Dividir los valores en dos partes y quedarse con la primera parte
Poblacion_Edad$Provincia <- sapply(strsplit(Poblacion_Edad$Provincia, "/"), `[`, 1)

# Quedarse solo con el  nombre
Poblacion_Edad$Provincia <- sub("^\\d{2} ", "", Poblacion_Edad$Provincia)

# Corregir los nombres de algunas Provincias
Poblacion_Edad$Provincia[Poblacion_Edad$Provincia == "Balears, Illes"] = "Baleares"

Poblacion_Edad$Provincia[Poblacion_Edad$Provincia == "Coruña, A"] = "A Coruña"

Poblacion_Edad$Provincia[Poblacion_Edad$Provincia == "Palmas, Las"] = "Las Palmas"

Poblacion_Edad$Provincia[Poblacion_Edad$Provincia == "Rioja, La"] = "La Rioja"

Poblacion_Edad$Provincia[Poblacion_Edad$Provincia == "Gipuzkoa"] = "Guipúzcoa"

Poblacion_Edad$Provincia[Poblacion_Edad$Provincia == "Araba"] = "Álava"

Poblacion_Edad$Provincia[Poblacion_Edad$Provincia == "Bizkaia"] = "Vizcaya"
```


```{r}
#write.xlsx(Poblacion_Edad,"Poblacion_Edad.xlsx",sheetName = "Poblacion_Edad")
write.xlsx(Poblacion_Edad,"../Poblacion_Edad.xlsx",sheetName = "Poblacion_Edad")
```



## Poblacion Comunidades

```{r}
Poblacion_Comunidades = Poblacion  %>% 
  arrange(Comunidad, Año) %>%
  group_by(Comunidad, Año) %>%
  summarise(Poblacion_Comunidad = sum(Total),
            Natalidad_Comunidad = sum(Natalidad),
            Mortalidad_Comunidad = sum(Mortalidad),
            Mig_in_ent__Comunidad = sum(Migracion_interna_entrada),
            Mig_in_sal_Comunidad = sum(Migracion_interna_salida),
            Mig_ex_ent__Comunidad = sum(Migracion_externa_entrada),
            Mig_ex_sal_Comunidad = sum(Migracion_externa_salida),
            Superficie_Comunidad = sum(Superficie),
            Variacion_Comunidad = sum(Variacion),
            Tasa_nat_Comunidad = sum(Tasa_natalidad),
            Tasa_mort_Comunidad = sum(Tasa_mortalidad),
            Tasa_mig_Comunidad = sum(Tasa_Migracion)) %>% 
  mutate(Densidad_Comunidad = round(Poblacion_Comunidad / Superficie_Comunidad,2) 
         ) 
Poblacion_Comunidades = Poblacion_Comunidades %>%  select(1,2,3,15,4:14)

Poblacion_Comunidades$Año <- as.numeric(Poblacion_Comunidades$Año)
```

```{r}
Poblacion_Comunidades = Poblacion_Comunidades %>% group_by(Comunidad) %>%
  mutate(Migracion_Comunidad = round(( Mig_in_ent__Comunidad + Mig_ex_ent__Comunidad) - (Mig_in_sal_Comunidad + Mig_ex_sal_Comunidad)),
         
         Variacion_Poblacion_2 = round((Poblacion_Comunidad - lag(Poblacion_Comunidad, 2)) / lag(Poblacion_Comunidad, 2) * 100,2),
         Variacion_Poblacion_4 = round((Poblacion_Comunidad - lag(Poblacion_Comunidad, 4)) / lag(Poblacion_Comunidad, 4) * 100,2),
         Variacion_Poblacion_10 = round((Poblacion_Comunidad - lag(Poblacion_Comunidad, 10)) / lag(Poblacion_Comunidad, 10) * 100,2),
         
         Variacion_Natalidad_2 = round((Natalidad_Comunidad - lag(Natalidad_Comunidad, 2)) / lag(Natalidad_Comunidad, 2) * 100,2),
         Variacion_Natalidad_4 = round((Natalidad_Comunidad - lag(Natalidad_Comunidad, 4)) / lag(Natalidad_Comunidad, 4) * 100,2),
         Variacion_Natalidad_10 = round((Natalidad_Comunidad - lag(Natalidad_Comunidad, 10)) / lag(Natalidad_Comunidad, 10) * 100,2),
         
         Variacion_Mortalidad_2 = round((Mortalidad_Comunidad - lag(Mortalidad_Comunidad, 2)) / lag(Mortalidad_Comunidad, 2) * 100,2),
         Variacion_Mortalidad_4 = round((Mortalidad_Comunidad - lag(Mortalidad_Comunidad, 4)) / lag(Mortalidad_Comunidad, 4) * 100,2),
         Variacion_Mortalidad_10 = round((Mortalidad_Comunidad - lag(Mortalidad_Comunidad, 10)) / lag(Mortalidad_Comunidad, 10) * 100,2),
         
         Variacion_Migracion_2 = round((Migracion_Comunidad - lag(Migracion_Comunidad, 2)) / lag(Migracion_Comunidad, 2) * 100,2),
         Variacion_Migracion_4 = round((Migracion_Comunidad - lag(Migracion_Comunidad, 4)) / lag(Migracion_Comunidad, 4) * 100,2),
         Variacion_Migracion_10 = round((Migracion_Comunidad - lag(Migracion_Comunidad, 10)) / lag(Migracion_Comunidad, 10) * 100,2),
         )
```

```{r}
correspondencia <- c(
  "Andalucía" = "AND",
  "Aragón" = "ARA",
  "Canarias" = "CAN",
  "Cantabria" = "CAB",
  "Castilla y León" = "CYL",
  "Castilla-La Mancha" = "CLM",
  "Cataluña" = "CAT",
  "Ceuta y Melilla" = "CEM",
  "Comunidad Foral de Navarra" = "NAV",
  "Comunidad Valenciana" = "VAL",
  "Comunidad de Madrid" = "MAD",
  "Extremadura" = "EXT",
  "Galicia" = "GAL",
  "Islas Baleares" = "BAL",
  "La Rioja" = "RIO",
  "País Vasco" = "VAS",
  "Principado de Asturias" = "AST",
  "Región de Murcia" = "MUR",
  "Total Nacional" = "NAC"
)

# Aplicamos la correspondencia para crear la columna de siglas
Poblacion_Comunidades$Siglas_Comunidad <- correspondencia[Poblacion_Comunidades$Comunidad]
```


```{r}
#write.xlsx(Poblacion_Comunidades,"Poblacion_Comunidades.xlsx",sheetName = "Poblacion_Comunidades")
write.xlsx(Poblacion_Comunidades,"../Poblacion_Comunidades.xlsx",sheetName = "Poblacion_Comunidades")
```



# Datos de Agua:

```{r}
Agua_disponible <- read_excel("Agua_disponible.xls")

Volumen_de_agua <- read_excel("Volumen de agua.xls")

Distribución_de_agua <- read_excel("Distribución de agua.xls")

Extension_territorial_Comunidades <- read_excel("Extension territorial Provincias.xlsx", 
    sheet = "Comunidades Autonomas")

Poblacion_Comunidad <- read_excel("Poblacion_Comunidad.xls")
```


## Organizamos el Agua disponible:

```{r}
Agua_disponible<- Agua_disponible %>% 
  gather(key="Año",value="Agua", -c(Comunidad,`Tipo de Agua`)) %>% select(1,3,2,4)

Agua_disponible = Agua_disponible %>% pivot_wider(names_from = `Tipo de Agua`,values_from = Agua)
```

## Organizamos el Volumen de Agua:

```{r}
Volumen_de_agua$`Volumen de agua`[Volumen_de_agua$`Volumen de agua` == "Volumen de agua suministrada a la red de abastecimiento público"] = "Volumen de agua suministrada"

Volumen_de_agua$`Volumen de agua`[Volumen_de_agua$`Volumen de agua` == "Volumen total de agua registrada y distribuida por tipo de usuario"] = "Volumen de agua registrada y distribuida"

Volumen_de_agua<- Volumen_de_agua %>% 
  gather(key="Año",value="Agua", -c(Comunidad,`Volumen de agua`)) %>% select(1,3,2,4)

Volumen_de_agua = Volumen_de_agua %>% pivot_wider(names_from = `Volumen de agua`,values_from = Agua)
```

## Organizamos la Distribucion del Agua:

```{r}
Distribución_de_agua<- Distribución_de_agua %>% 
  gather(key="Año",value="Agua", -c(Comunidad,`Grupo de Usuarios`)) %>% select(1,3,2,4)

Distribución_de_agua = Distribución_de_agua %>% pivot_wider(names_from = `Grupo de Usuarios`,values_from = Agua)
```

## Poblacion de las Comunidades:

```{r}
df_Ceuta_Melilla = Poblacion_Comunidad %>% filter(Comunidad == "18 Ceuta" | Comunidad == "19 Melilla") %>% select(-1)

df_Ceuta_Melilla <- data.frame(
  Comunidad = "Ceuta y Melilla",
  Año = colnames(df_Ceuta_Melilla),
  Poblacion = colSums(df_Ceuta_Melilla)
  ) 
Poblacion_Comunidad = Poblacion_Comunidad %>% filter(Comunidad != "18 Ceuta" & Comunidad != "19 Melilla") %>% 
  gather(key="Año",value="Poblacion", -Comunidad)


Poblacion_Comunidad = rbind(Poblacion_Comunidad,df_Ceuta_Melilla)
```


## Juntamos los datasets:
```{r}
Agua_España = merge(Volumen_de_agua,Distribución_de_agua,all = TRUE)

Agua_España = merge(Agua_España,Agua_disponible,all = TRUE)

Agua_España = merge(Agua_España,Poblacion_Comunidad,all = TRUE)
```

## Extension territorial de las Comunidades Autonomas:

```{r}
Extension_territorial_Comunidades = Extension_territorial_Comunidades[,-1]

names(Extension_territorial_Comunidades) = c("Superficie","Comunidad")

Extension_territorial_Comunidades = Extension_territorial_Comunidades %>% select(2,1)

# Calcular la suma de todas las provincias
total_superficie_2 <- sum(Extension_territorial_Comunidades$Superficie)

# Crear una nueva fila para la provincia "Total"
fila_total_2 <- data.frame(
  Comunidad = "Total Nacional",
  Superficie= total_superficie_2
)

# Unir la nueva fila al dataframe original
Extension_territorial_Comunidades <- rbind(Extension_territorial_Comunidades, fila_total_2)

Extension_territorial_Comunidades$Comunidad[Extension_territorial_Comunidades$Comunidad == "Principiado de Asturias"] = "Principado de Asturias"
```

## Interpolacion de los Datos

```{r}
# Agrupa el dataframe por Comunidad
Agua_España <- Agua_España %>% 
  arrange(Comunidad, Año) %>% 
  group_by(Comunidad) %>% 
  summarise_all(na.approx)
```


## Limpiamos la columna de Comunidad:

```{r}
# Dividir los valores en dos partes y quedarse con la primera parte
Agua_España$Comunidad <- sapply(strsplit(Agua_España$Comunidad, "/"), `[`, 1)

# Quedarse solo con el  nombre
Agua_España$Comunidad <- sub("^\\d{2} ", "", Agua_España$Comunidad)

Agua_España$Comunidad[Agua_España$Comunidad == "Balears, Illes"] = "Islas Baleares"

Agua_España$Comunidad[Agua_España$Comunidad == "Asturias, Principado de"] = "Principado de Asturias"

Agua_España$Comunidad[Agua_España$Comunidad == "Comunitat Valenciana"] = "Comunidad Valenciana"	

Agua_España$Comunidad[Agua_España$Comunidad == "Madrid, Comunidad de"] = "Comunidad de Madrid"

Agua_España$Comunidad[Agua_España$Comunidad == "Murcia, Región de"] = "Región de Murcia"	

Agua_España$Comunidad[Agua_España$Comunidad == "Navarra, Comunidad Foral de"] = "Comunidad Foral de Navarra"

Agua_España$Comunidad[Agua_España$Comunidad == "Rioja, La"] = "La Rioja"

Agua_España$Comunidad[Agua_España$Comunidad == "Castilla - La Mancha"] = "Castilla-La Mancha"


Agua_España = Agua_España %>%
  inner_join(Extension_territorial_Comunidades, by = "Comunidad")
```

## Indicadores:

```{r}
Agua_España = Agua_España %>% 
  arrange(Comunidad, Año) %>%
  group_by(Comunidad) %>%
  mutate(Eficiencia_Agua = round(`Volumen de agua registrada y distribuida` / `Volumen de agua suministrada` * 100,2),
         
         Agua_Km2 = round(`Volumen de agua suministrada` /Superficie * 1000,2),
         
         Consumo_Habitante = round((Hogares * 1000)/ Poblacion / 365 * 1000),
         )# Litro/Habitante/dia
```

```{r}
Agua_España = Agua_España %>%
    group_by(Comunidad) %>%
    mutate(
        Variacion_Suministro_2 = round((`Volumen de agua suministrada` - lag(`Volumen de agua suministrada`, 1)) / lag(`Volumen de agua suministrada`, 1) * 100,2),
        Variacion_Suministro_4 = round((`Volumen de agua suministrada` - lag(`Volumen de agua suministrada`, 2)) / lag(`Volumen de agua suministrada`, 2) * 100,2),
             Variacion_Suministro_10 = round((`Volumen de agua suministrada` - lag(`Volumen de agua suministrada`, 7)) / lag(`Volumen de agua suministrada`, 7) * 100,2),
        
        Variacion_Suministro_real_2 = round((`Volumen de agua registrada y distribuida` - lag(`Volumen de agua registrada y distribuida`, 1)) / lag(`Volumen de agua registrada y distribuida`, 1) * 100,2),
        Variacion_Suministro_real_4 = round((`Volumen de agua registrada y distribuida` - lag(`Volumen de agua registrada y distribuida`, 2)) / lag(`Volumen de agua registrada y distribuida`, 2) * 100,2),
             Variacion_Suministro_real_10 = round((`Volumen de agua registrada y distribuida` - lag(`Volumen de agua registrada y distribuida`, 7)) / lag(`Volumen de agua registrada y distribuida`, 7) * 100,2),
        
        Variacion_Hogares_2 = round((Hogares - lag(Hogares, 1)) / lag(Hogares, 1) * 100,2),
        Variacion_Hogares_4 = round((Hogares - lag(Hogares, 2)) / lag(Hogares, 2) * 100,2),
        Variacion_Hogares_10 = round((Hogares - lag(Hogares, 7)) / lag(Hogares, 7) * 100,2),
        
        Variacion_Consumo_Habitante_2 = round((Consumo_Habitante - lag(Consumo_Habitante, 1)) / lag(Consumo_Habitante, 1) * 100,2),
        Variacion_Consumo_Habitante_4 = round((Consumo_Habitante - lag(Consumo_Habitante, 2)) / lag(Consumo_Habitante, 2) * 100,2),
        Variacion_Consumo_Habitante_10 = round((Consumo_Habitante - lag(Consumo_Habitante, 7)) / lag(Consumo_Habitante, 7) * 100,2),
        
        Variacion_Agua_Potable_2 = round((Disponible_para_Potabilizacion - lag(Disponible_para_Potabilizacion, 1)) / lag(Disponible_para_Potabilizacion, 1) * 100,2),
        Variacion_Agua_Potable_4 = round((Disponible_para_Potabilizacion - lag(Disponible_para_Potabilizacion, 2)) / lag(Disponible_para_Potabilizacion, 2) * 100,2),
        Variacion_Agua_Potable_10 = round((Disponible_para_Potabilizacion - lag(Disponible_para_Potabilizacion, 7)) / lag(Disponible_para_Potabilizacion, 7) * 100,2),
        
        Var_Agua_No_Pot_2 = round((Disponible_no_Potabilizada - lag(Disponible_no_Potabilizada, 1)) / lag(Disponible_no_Potabilizada, 1) * 100,2),
        Var_Agua_No_Pot_4 = round((Disponible_no_Potabilizada - lag(Disponible_no_Potabilizada, 2)) / lag(Disponible_no_Potabilizada, 2) * 100,2),
        Var_Agua_No_Pot_10 = round((Disponible_no_Potabilizada - lag(Disponible_no_Potabilizada, 7)) / lag(Disponible_no_Potabilizada, 7) * 100,2),
        )
```

```{r}
correspondencia <- c(
  "Andalucía" = "AND",
  "Aragón" = "ARA",
  "Canarias" = "CAN",
  "Cantabria" = "CAB",
  "Castilla y León" = "CYL",
  "Castilla-La Mancha" = "CLM",
  "Cataluña" = "CAT",
  "Ceuta y Melilla" = "CEM",
  "Comunidad Foral de Navarra" = "NAV",
  "Comunidad Valenciana" = "VAL",
  "Comunidad de Madrid" = "MAD",
  "Extremadura" = "EXT",
  "Galicia" = "GAL",
  "Islas Baleares" = "BAL",
  "La Rioja" = "RIO",
  "País Vasco" = "VAS",
  "Principado de Asturias" = "AST",
  "Región de Murcia" = "MUR",
  "Total Nacional" = "NAC"
)

# Aplicamos la correspondencia para crear la columna de siglas
Agua_España$Siglas_Comunidad <- correspondencia[Agua_España$Comunidad]
```


```{r}
#write.xlsx(Agua_España,"Agua_España.xlsx",sheetName = "Agua_España")

write.xlsx(Agua_España,"../Agua_España.xlsx",sheetName = "Agua_España")
```

